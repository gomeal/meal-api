version: "3"

vars:
  GO_VERSION: "1.25"
  GOLANGCI_LINT_VERSION: "v2.5.0"
  GCI_VERSION: "v0.13.7"
  GOFUMPT_VERSION: "v0.9.1"
  BUF_VERSION: "1.53.0"
  PROTOC_GEN_GO_VERSION: "v1.36.6"
  PROTOC_GEN_GO_GRPC_VERSION: "v1.5.1"
  PROTOC_GEN_VALIDATE_VERSION: "v1.2.1"
  MOCKERY_VERSION: "v2.53.3"

  BIN_DIR: "{{.ROOT_DIR}}/bin"
  COVERAGE_DIR: "{{.ROOT_DIR}}/coverage"
  GOLANGCI_LINT: "{{.BIN_DIR}}/golangci-lint"
  GCI: "{{.BIN_DIR}}/gci"
  GOFUMPT: "{{.BIN_DIR}}/gofumpt"
  BUF: "{{.BIN_DIR}}/buf"
  PROTOC_GEN_GO: "{{.BIN_DIR}}/protoc-gen-go"
  PROTOC_GEN_GO_GRPC: "{{.BIN_DIR}}/protoc-gen-go-grpc"
  PROTOC_GEN_VALIDATE: "{{.BIN_DIR}}/protoc-gen-validate"
  PROJECT_PREFIX: "github.com/gomeal"
  MOCKERY: "{{.BIN_DIR}}/mockery"

tasks:
  # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
  install-tools:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹"
    cmds:
      - task: install-formatters
      - task: install-linter
      - task: install-proto-tools
      - task: install-mockery
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}
      - test -x {{.GOLANGCI_LINT}}
      - test -x {{.BUF}}
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}
      - test -x {{.PROTOC_GEN_VALIDATE}}
      - test -x {{.MOCKERY}}

  install-formatters:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€Ñ‹ gci Ð¸ gofumpt"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ ! -f {{.GOFUMPT}} ]; then
          echo "Installing gofumpt..."
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        fi
      - |
        if [ ! -f {{.GCI}} ]; then
          echo "Installing gci..."
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        fi
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  install-linter:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ golangci-lint"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ ! -f {{.GOLANGCI_LINT}} ]; then
          echo "Installing golangci-lint..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        fi
    status:
      - test -x {{.GOLANGCI_LINT}}

  install-proto-tools:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ buf Ð¸ protoc Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ ! -f {{.BUF}} ]; then
          echo "Installing buf..."
          GOBIN={{.BIN_DIR}} go install github.com/bufbuild/buf/cmd/buf@v{{.BUF_VERSION}}
        fi
      - |
        if [ ! -f {{.PROTOC_GEN_GO}} ]; then
          echo "Installing protoc-gen-go..."
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        fi
      - |
        if [ ! -f {{.PROTOC_GEN_GO_GRPC}} ]; then
          echo "Installing protoc-gen-go-grpc..."
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        fi
      - |
        if [ ! -f {{.PROTOC_GEN_VALIDATE}} ]; then
          echo "Installing protoc-gen-validate..."
          GOBIN={{.BIN_DIR}} go install github.com/envoyproxy/protoc-gen-validate@{{.PROTOC_GEN_VALIDATE_VERSION}}
        fi
    status:
      - test -x {{.BUF}}
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}
      - test -x {{.PROTOC_GEN_VALIDATE}}

  install-mockery:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ mockery"
    cmds:
      - |
        if [ ! -f {{.MOCKERY}} ]; then
          echo "Installing mockery..."
          GOBIN={{.BIN_DIR}} go install github.com/vektra/mockery/v2@{{.MOCKERY_VERSION}}
        fi
    status:
      - test -x {{.MOCKERY}}

  # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
  format:
    desc: "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÐµÑÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚"
    deps: [install-formatters]
    cmds:
      - echo "ðŸ§¼ Formatting Go files..."
      - find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' -exec {{.GOFUMPT}} -w {} +
      - find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' -exec {{.GCI}} write -s standard -s default -s "prefix({{.PROJECT_PREFIX}})" {} +

  lint:
    desc: "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÐºÐ¾Ð´ Ð»Ð¸Ð½Ñ‚ÐµÑ€Ð°Ð¼Ð¸"
    deps: [install-linter]
    cmds:
      - echo "ðŸ” Running linters..."
      - "{{.GOLANGCI_LINT}} run ./..."

  mockgen:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¼Ð¾ÐºÐ¸ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· mockery"
    deps: [install-mockery]
    cmds:
        - echo 'ðŸ§ª Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¼Ð¾ÐºÐ¾Ð²...'
        - "{{.MOCKERY}}"

  # Proto ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
  proto:generate:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Go ÐºÐ¾Ð´ Ð¸Ð· proto Ñ„Ð°Ð¹Ð»Ð¾Ð²"
    deps: [install-proto-tools]
    cmds:
      - task: proto:update-deps
      - task: proto:lint
      - task: proto:gen
      - echo "âœ… Proto generation completed!"

  proto:update-deps:
    desc: "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ protobuf"
    deps: [install-proto-tools]
    dir: proto
    cmds:
      - echo "Updating proto dependencies..."
      - "{{.BUF}} dep update"

  proto:lint:
    desc: "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ .proto Ñ„Ð°Ð¹Ð»Ñ‹"
    deps: [install-proto-tools]
    dir: proto
    cmds:
      - echo "Linting proto files..."
      - "{{.BUF}} lint"

  proto:gen:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Go ÐºÐ¾Ð´ Ð¸Ð· .proto"
    deps: [install-proto-tools]
    dir: proto
    cmds:
      - echo "Generating Go code..."
      - "{{.BUF}} generate"

  # ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  test:
    desc: "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ñ‚ÐµÑÑ‚Ñ‹, Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÐµÐ³Ð¾ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ"
    cmds:
      - task: test-coverage
      - task: coverage:html

  test-coverage:
    desc: "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ñ‚ÐµÑÑ‚Ñ‹ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ¸"
    cmds:
      - echo "ðŸ§ª Running tests with coverage..."
      - rm -rf {{.COVERAGE_DIR}}
      - mkdir -p {{.COVERAGE_DIR}}
      - |
        TARGET_PACKAGES=$(go list ./internal/... | grep -v "/mocks" | grep -E '/(apis|clients|services|repositories)(/|$)' | tr '\n' ',')
        if [ -z "$TARGET_PACKAGES" ]; then
          echo "âš ï¸ No packages found for testing"
          exit 1
        fi
        go test -v -coverprofile={{.COVERAGE_DIR}}/coverage.out -coverpkg=$TARGET_PACKAGES ./...
        go tool cover -func={{.COVERAGE_DIR}}/coverage.out | tail -n1

  coverage:html:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÐµÐ³Ð¾ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ"
    cmds:
      - echo "ðŸŒ Generating HTML coverage report..."
      - |
        OUTPUT={{.COVERAGE_DIR}}/coverage.html
        go tool cover -html={{.COVERAGE_DIR}}/coverage.out -o $OUTPUT
        if command -v open &> /dev/null; then
          open $OUTPUT
        elif command -v xdg-open &> /dev/null; then
          xdg-open $OUTPUT
        fi
