version: "3"

vars:
  GO_VERSION: "1.25"
  GOLANGCI_LINT_VERSION: "v2.5.0"
  GCI_VERSION: "v0.13.7"
  GOFUMPT_VERSION: "v0.9.1"
  BUF_VERSION: "1.53.0"
  PROTOC_GEN_GO_VERSION: "v1.36.6"
  PROTOC_GEN_GO_GRPC_VERSION: "v1.5.1"
  PROTOC_GEN_VALIDATE_VERSION: "v1.2.1"

  BIN_DIR: "{{.ROOT_DIR}}/bin"
  GOLANGCI_LINT: "{{.BIN_DIR}}/golangci-lint"
  GCI: "{{.BIN_DIR}}/gci"
  GOFUMPT: "{{.BIN_DIR}}/gofumpt"
  BUF: "{{.BIN_DIR}}/buf"
  PROTOC_GEN_GO: "{{.BIN_DIR}}/protoc-gen-go"
  PROTOC_GEN_GO_GRPC: "{{.BIN_DIR}}/protoc-gen-go-grpc"
  PROTOC_GEN_VALIDATE: "{{.BIN_DIR}}/protoc-gen-validate"
  PROJECT_PREFIX: "github.com/gomeal"

tasks:
  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
  install-tools:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"
    cmds:
      - task: install-formatters
      - task: install-linter
      - task: install-proto-tools
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}
      - test -x {{.GOLANGCI_LINT}}
      - test -x {{.BUF}}
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}
      - test -x {{.PROTOC_GEN_VALIDATE}}

  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ ! -f {{.GOFUMPT}} ]; then
          echo "Installing gofumpt..."
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        fi
      - |
        if [ ! -f {{.GCI}} ]; then
          echo "Installing gci..."
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        fi
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  install-linter:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ ! -f {{.GOLANGCI_LINT}} ]; then
          echo "Installing golangci-lint..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        fi
    status:
      - test -x {{.GOLANGCI_LINT}}

  install-proto-tools:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç buf –∏ protoc –ø–ª–∞–≥–∏–Ω—ã"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ ! -f {{.BUF}} ]; then
          echo "Installing buf..."
          GOBIN={{.BIN_DIR}} go install github.com/bufbuild/buf/cmd/buf@v{{.BUF_VERSION}}
        fi
      - |
        if [ ! -f {{.PROTOC_GEN_GO}} ]; then
          echo "Installing protoc-gen-go..."
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        fi
      - |
        if [ ! -f {{.PROTOC_GEN_GO_GRPC}} ]; then
          echo "Installing protoc-gen-go-grpc..."
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        fi
      - |
        if [ ! -f {{.PROTOC_GEN_VALIDATE}} ]; then
          echo "Installing protoc-gen-validate..."
          GOBIN={{.BIN_DIR}} go install github.com/envoyproxy/protoc-gen-validate@{{.PROTOC_GEN_VALIDATE_VERSION}}
        fi
    status:
      - test -x {{.BUF}}
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}
      - test -x {{.PROTOC_GEN_VALIDATE}}

  # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç"
    deps: [install-formatters]
    cmds:
      - echo "üßº Formatting Go files..."
      - find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' -exec {{.GOFUMPT}} -w {} +
      - find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' -exec {{.GCI}} write -s standard -s default -s "prefix({{.PROJECT_PREFIX}})" {} +

  lint:
    desc: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–∞–º–∏"
    deps: [install-linter]
    cmds:
      - echo "üîç Running linters..."
      - "{{.GOLANGCI_LINT}} run ./..."

  # Proto –∫–æ–º–∞–Ω–¥—ã
  proto:generate:
    desc: "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Go –∫–æ–¥ –∏–∑ proto —Ñ–∞–π–ª–æ–≤"
    deps: [install-proto-tools]
    cmds:
      - task: proto:update-deps
      - task: proto:lint
      - task: proto:gen
      - echo "‚úÖ Proto generation completed!"

  proto:update-deps:
    desc: "–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ protobuf"
    deps: [install-proto-tools]
    dir: proto
    cmds:
      - echo "Updating proto dependencies..."
      - "{{.BUF}} dep update"

  proto:lint:
    desc: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç .proto —Ñ–∞–π–ª—ã"
    deps: [install-proto-tools]
    dir: proto
    cmds:
      - echo "Linting proto files..."
      - "{{.BUF}} lint"

  proto:gen:
    desc: "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Go –∫–æ–¥ –∏–∑ .proto"
    deps: [install-proto-tools]
    dir: proto
    cmds:
      - echo "Generating Go code..."
      - "{{.BUF}} generate"
